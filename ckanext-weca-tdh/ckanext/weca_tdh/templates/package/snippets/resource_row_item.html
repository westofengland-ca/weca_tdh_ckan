{#
  Renders a single data resource

  res - A resource dict to render
  pkg - A package dict that the resource belongs to
  can_edit - Whether the user is allowed to edit the resource

  Example: {% snippet 'package/snippets/resource_row_item.html', pkg=pkg, res=resource, can_edit=can_edit %}
#}

{% set url_action = pkg.type ~ ('_resource.edit' if url_is_edit and can_edit else '_resource.read') %}
{% set external = res.resource_data_access and res.resource_data_access in ('External Link', 'Power BI Report') %}
{% set url = res.url if external else url or h.url_for(url_action, id=pkg.name, resource_id=res.id) %}

{% block resource_item %}
  <tr class="govuk-table__row">
    <td class="govuk-table__cell">
      <a class="govuk-link" href="{{ url }}">{{ h.resource_display_name(res) | truncate(50) }}</a>
    </td>
    <td class="govuk-table__cell">
      {{ res.format or 'Data' }}
    </td>
    <td class="govuk-table__cell">
      {% set data_layer = res.resource_data_layer %}
      {% if data_layer %}
        <i class="fa {% if data_layer=='Wood' %}fa-signs-post{% else %}fa-database{% endif %} medallion-level-{{data_layer|lower}}"></i> {{ data_layer }}
      {% else %}
        <i class="fa fa-signs-post medallion-level-wood"></i> {{ _('Wood') }}
      {% endif %}
    </td>
    <td class="govuk-table__cell">
      {% if res.resource_data_access %}
        {{ res.resource_data_access }} 
      {% else %}
        {% if res.url and h.is_url(res.url) %}
          {{ _('External Link') }}
        {% elif res.has_views %}
          {{ _('Preview') }}
        {% else %}
          {{ _('N/A') }}
        {% endif %}
      {% endif %}
    </td>
    <td class="govuk-table__cell">
      <a href="{{ h.url_for('pages.show', page='support') ~ '#data-categories'}}">
        {% set categories = h.get_resource_data_categories() %}
        {% if res.resource_data_category %}
          {% for category in categories %}
            {% if category.id == res.resource_data_category | int %}
              <span class="badge {{ category.class }}">{{ category.name }}</span>
            {% endif %}
          {% endfor %}
        {% else %}
          <span class="badge {{ categories[0].class }}">{{ categories[0].name | upper }}</span>
        {% endif %}
      </a>
    </td>
    <td class="govuk-table__cell">
      {% block resource_item_explore %}
        {% if not url_is_edit %}
          <div class="dropdown btn-group">
            <a href="#" class="btn btn-primary dropdown-toggle" type="button" id="dropdownExplorer" 
              data-bs-toggle="dropdown" aria-expanded="false" aria-label="Explore data">
              <i class="fa fa-share"></i>
            </a>
            <ul class="dropdown-menu" aria-labelledby="dropdownExplorer">
              {% block resource_item_explore_links %}
                {% if res.url and h.is_url(res.url) %}
                  <li>
                    {% if res.url_type != 'upload' %}
                      <a class="dropdown-item" href="{{ res.url }}">
                        <i class="fa fa-external-link"></i>
                        {{ _('Go to resource') }}
                      </a>
                    {% else %}
                      <a class="dropdown-item" href="{{ res.url }}" target="_blank" rel="noreferrer noopener">
                        <i class="fa fa-arrow-circle-down"></i>
                        {{ _('Download') }}
                      </a>
                    {% endif %}
                  </li>
                {% endif %}

                {% if res.resource_data_access == "TDH Query" %}
                  <li>
                    <a class="dropdown-item" id="ga-tdh-connect-{{ res.id }}"
                      href="{{ h.url_for('action.tdh_partner_connect_file') }}?tdh_catalog={{ res.tdh_catalog }}&tdh_schema={{ tdh_schema }}" 
                      download="TDH-{{ res.name | replace(' ', '_') }}.pbids">
                      <i class="fa fa-arrow-circle-down"></i>
                      {{ _('Partner Connect File') }}
                    </a>
                  </li>
                {% endif %}

                {% block explore_view %}
                  <li>
                    <a class="dropdown-item" href="{{ h.url_for(url_action, id=pkg.name, resource_id=res.id) }}">
                      {% if res.has_views %}
                        <i class="fa fa-chart-bar"></i>
                        {{ _('Preview') }}
                      {% else %}
                        <i class="fa fa-info-circle"></i>
                        {{ _('More information') }}
                      {% endif %}
                    </a>
                  </li>
                {% endblock explore_view %}

                {% if can_edit %}
                  <li>{% link_for _('Edit resource'), named_route=pkg.type ~ '_resource.edit', id=pkg.name, resource_id=res.id, class_='dropdown-item', icon='pencil' %}</li>
                {% endif %}
              {% endblock %}
            </ul>
          </div>
        {% endif %}
      {% endblock %}
    </td>
  </tr>
{% endblock %}
